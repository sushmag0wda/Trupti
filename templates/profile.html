{% extends "base.html" %}
{% load humanize %}
{% block title %}Profile | Trupti{% endblock %}
{% block content %}
  <div class="row g-4 align-items-start">
    <div class="col-12">
      <div class="card-trupti p-4 mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
          <div>
            <h1 class="section-heading fs-3 mb-1">Hello, {{ user_obj.first_name|default:user_obj.username }}!</h1>
            <p class="text-muted mb-0">Here’s a snapshot of your journey with Trupti.</p>
          </div>
          <span class="badge bg-light text-dark text-uppercase">{{ user_obj.get_role_display }}</span>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="profile-summary">
        {% if user_obj.is_donor %}
          <div class="metric-card">
            <h3 class="h6 text-uppercase mb-1">Total donations</h3>
            <p class="display-6 fw-semibold mb-0">{{ stats.total_donations }}</p>
            <small class="text-muted">{{ stats.claimed_donations }} marked as claimed</small>
          </div>
          <div class="metric-card">
            <h3 class="h6 text-uppercase mb-1">Requests received</h3>
            <p class="display-6 fw-semibold mb-0">{{ stats.requests_received }}</p>
            <small class="text-muted">Across all your donations</small>
          </div>
          <div class="metric-card">
            <h3 class="h6 text-uppercase mb-1">Requests accepted</h3>
            <p class="display-6 fw-semibold mb-0">{{ stats.accepted_requests_received|default:0 }}</p>
            <small class="text-muted">You've helped feed people</small>
          </div>
        {% else %}
          <div class="metric-card">
            <h3 class="h6 text-uppercase mb-1">Requests sent</h3>
            <p class="display-6 fw-semibold mb-0">{{ stats.requests_sent }}</p>
            <small class="text-muted">Total requests made</small>
          </div>
          <div class="metric-card">
            <h3 class="h6 text-uppercase mb-1">Requests accepted</h3>
            <p class="display-6 fw-semibold mb-0">{{ stats.accepted_requests|default:0 }}</p>
            <small class="text-muted">Successfully received meals</small>
          </div>
          <div class="metric-card">
            <h3 class="h6 text-uppercase mb-1">Active requests</h3>
            <p class="display-6 fw-semibold mb-0">{{ stats.pending_requests|default:0 }}</p>
            <small class="text-muted">Waiting for response</small>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card-trupti p-4 h-100">
        <h2 class="h5 fw-semibold mb-3">Personal details</h2>
        <dl class="row mb-0 g-2">
          <dt class="col-5 text-muted">Name</dt>
          <dd class="col-7 mb-0">{{ user_obj.get_full_name|default:user_obj.username }}</dd>
          <dt class="col-5 text-muted">Email</dt>
          <dd class="col-7 mb-0">{{ user_obj.email|default:"—" }}</dd>
          <dt class="col-5 text-muted">Contact</dt>
          <dd class="col-7 mb-0">{{ user_obj.contact_number|default:"—" }}</dd>
          <dt class="col-5 text-muted">Role</dt>
          <dd class="col-7 mb-0">{{ user_obj.get_role_display }}</dd>
          <dt class="col-5 text-muted">Address</dt>
          <dd class="col-7 mb-0">{{ user_obj.address|linebreaksbr|default:"—" }}</dd>
          <dt class="col-5 text-muted">Member since</dt>
          <dd class="col-7 mb-0">{{ user_obj.date_joined|date:"M d, Y" }}</dd>
        </dl>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card-trupti p-4 mb-4">
        <h2 class="h5 fw-semibold mb-3">Recent activity</h2>
        <ul class="timeline mb-0">
          {% if user_obj.is_donor %}
            {% if recent_donations %}
              {% for donation in recent_donations %}
                <li class="timeline-item">
                  <h3 class="h6 mb-1">{{ donation.food_name }}</h3>
                  <p class="small mb-1">Status: {{ donation.get_status_display }}</p>
                  <small>Listed {{ donation.created_at|naturaltime }}</small>
                </li>
              {% endfor %}
            {% else %}
              <li class="timeline-item">
                <p class="mb-0">No donations listed yet. Share a meal to create your first entry!</p>
              </li>
            {% endif %}
          {% else %}
            {% if recent_requests_sent %}
              {% for req in recent_requests_sent %}
                <li class="timeline-item">
                  <h3 class="h6 mb-1">{{ req.donation.food_name }}</h3>
                  <p class="small mb-1">Status: {{ req.get_status_display }}</p>
                  <small>Requested {{ req.timestamp|naturaltime }}</small>
                </li>
              {% endfor %}
            {% else %}
              <li class="timeline-item">
                <p class="mb-0">No requests yet. Explore donations to get started.</p>
              </li>
            {% endif %}
          {% endif %}
        </ul>
      </div>

      {% if user_obj.is_donor and recent_requests_received %}
        <div class="card-trupti p-4">
          <h2 class="h6 text-uppercase text-muted mb-3">Latest incoming requests</h2>
          <ul class="timeline mb-0">
            {% for req in recent_requests_received %}
              <li class="timeline-item">
                <h3 class="h6 mb-1">{{ req.receiver.username }} requested {{ req.donation.food_name }}</h3>
                <p class="small mb-1">Status: {{ req.get_status_display }}</p>
                <small>{{ req.timestamp|naturaltime }}</small>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>

    <div class="col-12">
      <div class="card-trupti p-4">
        <h2 class="h5 fw-semibold mb-3">Need anything else?</h2>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="metric-card h-100">
              <h3 class="h6 text-uppercase mb-2">Learn about Trupti</h3>
              <p class="small mb-3">Revisit our mission, values, and how the platform works.</p>
              <a class="btn-trupti-outline" href="{% url 'about' %}">Read about us</a>
            </div>
          </div>
          <div class="col-md-6">
            <div class="metric-card h-100">
              <h3 class="h6 text-uppercase mb-2">Contact the team</h3>
              <p class="small mb-3">Share feedback or request support—we’re here for you.</p>
              <a class="btn-trupti-outline" href="{% url 'contact' %}">Get in touch</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
